<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Organizator recepata i potro≈°nje sastojaka (deljeni)</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <div id="app" class="max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-6">
    <h1 class="text-3xl font-bold mb-4 text-center text-green-700">
      ü•ï Organizator recepata i potro≈°nje sastojaka ‚Äî DELJENO
    </h1>

    <!-- Toolbar -->
    <div class="flex flex-wrap items-center gap-2 mb-6">
      <input v-model="me" placeholder="Tvoje ime (opciono)" class="border rounded-lg p-2 text-sm" style="min-width:180px">
      <button @click="syncNow" class="px-3 py-2 rounded-lg bg-gray-100 text-sm hover:bg-gray-200">Osve≈æi</button>

      <button @click="exportLocal" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700">Izvezi lokalno (.json)</button>
      <label class="px-3 py-2 rounded-lg bg-white border text-blue-700 text-sm cursor-pointer hover:bg-blue-50">
        Uvezi (.json)
        <input type="file" class="hidden" accept="application/json" @change="importLocal">
      </label>
    </div>

    <!-- Add recipe -->
    <div class="mb-10">
      <h2 class="text-xl font-semibold mb-3">Dodaj novi recept (vidljiv svima)</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input v-model="draft.name" placeholder="Naziv recepta" class="border rounded-lg p-2" />
        <input v-model="draft.ingredients" placeholder="Sastojci (zarez ili novi red)" class="border rounded-lg p-2" />
      </div>
      <textarea v-model="draft.instructions" placeholder="Uputstvo za pripremu" class="border rounded-lg p-2 w-full mt-3"></textarea>
      <div class="mt-3">
        <span class="block text-sm font-medium text-gray-700 mb-1">Kategorije (mo≈æe vi≈°e):</span>
        <label class="mr-4 inline-flex items-center gap-2 text-sm"><input type="checkbox" v-model="draft.categories" value="Doruƒçak" /> Doruƒçak</label>
        <label class="mr-4 inline-flex items-center gap-2 text-sm"><input type="checkbox" v-model="draft.categories" value="Ruƒçak" /> Ruƒçak</label>
        <label class="mr-4 inline-flex items-center gap-2 text-sm"><input type="checkbox" v-model="draft.categories" value="Veƒçera" /> Veƒçera</label>
      </div>
      <button @click="createRecipe" class="mt-3 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Dodaj recept (u bazu)</button>
    </div>

    <!-- Search -->
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-3">Pronaƒëi recepte</h2>
      <input v-model="q" placeholder="Tra≈æi po sastojku / imenu" class="border rounded-lg p-2 w-full" />
    </div>

    <!-- Recipes list -->
    <div>
      <h2 class="text-xl font-semibold mb-3">Recepti (deljeni)</h2>
      <transition-group name="fade" tag="div">
        <div v-for="r in filtered" :key="r.id" class="border rounded-xl p-4 mb-4 bg-gray-100 hover:bg-green-50 transition">
          <div class="flex items-start justify-between gap-4">
            <div class="min-w-0">
              <h3 class="text-lg font-bold text-green-700 break-words">{{ r.name }}</h3>
              <div class="flex flex-wrap gap-2 my-1">
                <span v-for="cat in (r.categories || [])" :key="r.id+'-'+cat" class="px-2 py-0.5 text-xs rounded-full bg-green-200 text-green-900">{{ cat }}</span>
              </div>
              <p class="text-sm text-gray-700"><strong>Sastojci:</strong> {{ r.ingredients }}</p>
              <p class="mt-2 text-gray-800 whitespace-pre-line">{{ r.instructions }}</p>
              <p class="mt-1 text-xs text-gray-500" v-if="r.author">Dodao: {{ r.author }}</p>
            </div>
            <div class="shrink-0 text-right w-56">
              <div class="grid grid-cols-2 gap-2">
                <button class="px-3 py-1 rounded-lg bg-yellow-100 text-yellow-800 text-sm hover:bg-yellow-200" @click="openEdit(r)">Uredi</button>
                <button class="px-3 py-1 rounded-lg bg-red-100 text-red-700 text-sm hover:bg-red-200" @click="removeRecipe(r)">Obri≈°i</button>
              </div>
            </div>
          </div>
        </div>
      </transition-group>
      <p v-if="filtered.length === 0" class="text-gray-500 italic">Nema recepata sa tim kriterijumom.</p>
    </div>

    <!-- Edit modal -->
    <div v-if="editing" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-6">
        <h3 class="text-xl font-bold mb-4">Uredi recept</h3>
        <div class="grid grid-cols-1 gap-3">
          <input v-model="editDraft.name" placeholder="Naziv recepta" class="border rounded-lg p-2" />
          <textarea v-model="editDraft.ingredients" placeholder="Sastojci" class="border rounded-lg p-2 w-full"></textarea>
          <textarea v-model="editDraft.instructions" placeholder="Uputstvo" class="border rounded-lg p-2 w-full"></textarea>
          <div>
            <span class="block text-sm font-medium text-gray-700 mb-1">Kategorije:</span>
            <div class="flex flex-wrap gap-4 text-sm">
              <label class="inline-flex items-center gap-2"><input type="checkbox" v-model="editDraft.categories" value="Doruƒçak" /> Doruƒçak</label>
              <label class="inline-flex items-center gap-2"><input type="checkbox" v-model="editDraft.categories" value="Ruƒçak" /> Ruƒçak</label>
              <label class="inline-flex items-center gap-2"><input type="checkbox" v-model="editDraft.categories" value="Veƒçera" /> Veƒçera</label>
            </div>
          </div>
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button class="px-4 py-2 rounded-lg bg-white border text-gray-700 hover:bg-gray-100" @click="cancelEdit">Otka≈æi</button>
          <button class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700" @click="saveEdit">Saƒçuvaj</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === SUPABASE CONFIG (zameni svojim) ===
    const SUPABASE_URL = 'https://ikhsmokgbxixeiyppydi.supabase.co';
    const SUPABASE_ANON_KEY = 'process.env.SUPABASE_KEY';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const app = Vue.createApp({
      data() {
        return {
          me: localStorage.getItem('me') || '',
          draft: { name: '', ingredients: '', instructions: '', categories: [] },
          recipes: [],
          q: '',
          editing: false,
          editDraft: { id:null, name:'', ingredients:'', instructions:'', categories:[] }
        };
      },
      computed: {
        filtered() {
          const q = this.q.toLowerCase();
          return this.recipes.filter(r =>
            !q ||
            (r.name && r.name.toLowerCase().includes(q)) ||
            (r.ingredients && r.ingredients.toLowerCase().includes(q)) ||
            ((r.categories||[]).join(' ').toLowerCase().includes(q))
          ).sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
        }
      },
      methods: {
        // CRUD
        async createRecipe() {
          if (!this.draft.name || !this.draft.ingredients) { alert('Naziv i sastojci su obavezni.'); return; }
          const row = {
            name: this.draft.name.trim(),
            ingredients: this.draft.ingredients.replace(/\n/g, ',').split(',').map(x=>x.trim()).filter(Boolean).join(', '),
            instructions: (this.draft.instructions||'').trim(),
            categories: Array.isArray(this.draft.categories) ? this.draft.categories : [],
            author: (this.me||'').trim() || null
          };
          const { error } = await sb.from('recipes').insert(row);
          if (error) { alert('Gre≈°ka pri dodavanju: ' + error.message); return; }
          this.draft = { name:'', ingredients:'', instructions:'', categories:[] };
        },
        openEdit(r){
          this.editing = true;
          this.editDraft = JSON.parse(JSON.stringify(r));
          if (!Array.isArray(this.editDraft.categories)) this.editDraft.categories = [];
        },
        cancelEdit(){ this.editing = false; this.editDraft = { id:null, name:'', ingredients:'', instructions:'', categories:[] }; },
        async saveEdit(){
          const id = this.editDraft.id;
          if (!id) return this.cancelEdit();
          const upd = {
            name: (this.editDraft.name||'').trim(),
            ingredients: (this.editDraft.ingredients||'').replace(/\n/g, ',').split(',').map(x=>x.trim()).filter(Boolean).join(', '),
            instructions: (this.editDraft.instructions||'').trim(),
            categories: Array.isArray(this.editDraft.categories) ? this.editDraft.categories : []
          };
          if (!upd.name || !upd.ingredients) { alert('Naziv i sastojci su obavezni.'); return; }
          const { error } = await sb.from('recipes').update(upd).eq('id', id);
          if (error) { alert('Gre≈°ka pri ƒçuvanju: ' + error.message); return; }
          this.cancelEdit();
        },
        async removeRecipe(r){
          if (!confirm('Obrisati recept: ' + r.name + '?')) return;
          const { error } = await sb.from('recipes').delete().eq('id', r.id);
          if (error) alert('Gre≈°ka pri brisanju: ' + error.message);
        },

        // Sync
        async syncNow(){
          const { data, error } = await sb.from('recipes').select('*').order('created_at', { ascending:false });
          if (error) { console.error(error); alert('Gre≈°ka pri uƒçitavanju.'); return; }
          this.recipes = data || [];
        },

        // Local export/import (opciono)
        exportLocal(){
          const blob = new Blob([JSON.stringify(this.recipes, null, 2)], {type:'application/json'});
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'recepti.json'; a.click(); URL.revokeObjectURL(a.href);
        },
        importLocal(e){
          const file = e.target.files?.[0]; if (!file) return;
          const reader = new FileReader();
          reader.onload = async () => {
            try {
              const arr = JSON.parse(reader.result);
              if (!Array.isArray(arr)) throw new Error('Neispravan format');
              // Bulk insert (duplikati po nazivu su moguƒái ‚Äî po potrebi dodaƒáemo unique constraint na name)
              const { error } = await sb.from('recipes').insert(arr.map(r=>({
                name: r.name, ingredients: r.ingredients, instructions: r.instructions,
                categories: Array.isArray(r.categories) ? r.categories : [], author: this.me||null
              })));
              if (error) throw error;
              alert('Uvoz zavr≈°en.');
            } catch(err){ alert('Import nije uspeo: ' + err.message); }
            e.target.value = '';
          };
          reader.readAsText(file);
        }
      },
      async mounted(){
        // Saƒçuvaj "me"
        this.$watch('me', v => localStorage.setItem('me', v || ''), { immediate: true });

        // Inicijalno uƒçitavanje
        await this.syncNow();

        // Realtime: reaguj na promene iz baze
        sb
          .channel('public:recipes')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'recipes' }, (payload) => {
            const { eventType, new: newRow, old: oldRow } = payload;
            if (eventType === 'INSERT' && newRow) {
              // Ubaci na poƒçetak ako ga veƒá nemamo
              if (!this.recipes.some(x => x.id === newRow.id)) this.recipes.unshift(newRow);
            } else if (eventType === 'UPDATE' && newRow) {
              const i = this.recipes.findIndex(x => x.id === newRow.id);
              if (i !== -1) this.recipes.splice(i, 1, newRow);
            } else if (eventType === 'DELETE' && oldRow) {
              this.recipes = this.recipes.filter(x => x.id !== oldRow.id);
            }
          })
          .subscribe();
      }
    });
    app.mount('#app');
  </script>
</body>
</html>

